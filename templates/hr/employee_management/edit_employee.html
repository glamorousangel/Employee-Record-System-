<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Management System - Edit Employee</title>
    <link rel="stylesheet" href="../../../static/css/editemployee.css">
</head>
<body>

    <div class="container">
        <aside class="sidebar"></aside>

        <main class="main">
            <div class="content-card">
                <form class="form-grid" id="editEmployeeForm">
                    <section class="form-section-box">
                        <div class="section-header">Basic Information</div>
                        <div class="section-body">
                            <div class="photo-container">
                                <div class="photo-circle">
                                    <svg viewBox="0 0 24 24" width="50" height="50"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                </div>
                                <span class="photo-label">Upload Photo (Optional)</span>
                            </div>

                            <div class="inputs-row">
                                <div class="input-item"><label>First Name</label><input type="text" id="firstName" placeholder="Enter first name" required></div>
                                <div class="input-item"><label>Last Name</label><input type="text" id="lastName" placeholder="Enter last name" required></div>
                                <div class="input-item"><label>Employment I.D</label><input type="text" id="empID" placeholder="Enter Employment I.D" readonly style="background-color: #f0f0f0; cursor: not-allowed;"></div>
                                <div class="input-item">
                                    <label>Employment Status</label>
                                    <select id="empStatus" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;">
                                        <option value="Active">Active</option>
                                        <option value="Inactive">Inactive</option>
                                        <option value="On Leave">On Leave</option>
                                    </select>
                                </div>
                                <div class="input-item"><label>Employment Type</label><input type="text" id="empType" placeholder="Enter Employment Type"></div>
                                <div class="input-item"><label>Department / Office</label><input type="text" id="dept" placeholder="Enter Department / Office" required></div>
                                <div class="input-item"><label>Position/Rank</label><input type="text" id="pos" placeholder="Enter Position/Rank" required></div>
                                <div class="input-item"><label>Date Hired</label><input type="date" id="dateHired" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc;"></div>
                            </div>
                        </div>
                    </section>

                    <section class="form-section-box">
                        <div class="section-header">Personal Information</div>
                        <div class="section-body">
                            <div class="full-width-item"><label>Email Address</label><input type="email" id="email" placeholder="Enter Email Address"></div>
                            <div class="full-width-item"><label>Contact Number</label><input type="text" id="contact" placeholder="Enter Contact Number"></div>
                            <div class="full-width-item"><label>Address</label><input type="text" id="address" placeholder="Enter Address"></div>
                            <h4 class="sub-header">Emergency Contact</h4>
                            <div class="inputs-row">
                                <div class="input-item"><label>Emergency Contact Name</label><input type="text" id="emergencyName" placeholder="Enter Emergency Contact Name"></div>
                                <div class="input-item"><label>Emergency Contact Number</label><input type="text" id="emergencyPhone" placeholder="Enter Emergency Contact Number"></div>
                            </div>
                        </div>
                    </section>
                </form>

                <div class="form-footer">
                    <button type="button" class="btn btn-save" id="deleteBtn" style="margin-right: auto;">Delete Record</button>
                    <button type="button" class="btn btn-cancel" onclick="handleCancel()">Cancel</button>
                    <button type="button" class="btn btn-save" onclick="updateEmployee()">Update Changes</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // NEW: Helper to determine where to go back to
        function getReturnURL() {
            const params = new URLSearchParams(window.location.search);
            const source = params.get('source');
            const id = params.get('id');
            
            if (source === 'profile') {
                return `profile_employee.html?id=${id}`;
            } else {
                return 'list.html';
            }
        }

        function handleCancel() {
            window.location.href = getReturnURL();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const idToEdit = params.get('id');
            let employees = JSON.parse(localStorage.getItem('addedEmployees')) || [];

            let empData = employees.find(e => e.id === idToEdit);
            
            if (!empData && idToEdit === "001") {
                empData = { id: "001", fullName: "Dela Cruz, Juan", dept: "College of Computer Studies (CCS)", pos: "Instructor", status: "Active" };
            }

            if (empData) {
                if (empData.fullName && empData.fullName.includes(',')) {
                    const parts = empData.fullName.split(',');
                    document.getElementById('lastName').value = parts[0].trim();
                    document.getElementById('firstName').value = parts[1].trim();
                } else {
                    document.getElementById('firstName').value = empData.fullName || "";
                }
                document.getElementById('empID').value = empData.id || "";
                document.getElementById('empStatus').value = empData.status || "Active";
                document.getElementById('empType').value = empData.empType || "";
                document.getElementById('dept').value = empData.dept || "";
                document.getElementById('pos').value = empData.pos || "";
                document.getElementById('dateHired').value = empData.dateHired || "";
                document.getElementById('email').value = empData.email || "";
                document.getElementById('contact').value = empData.contact || "";
                document.getElementById('address').value = empData.address || "";
                document.getElementById('emergencyName').value = empData.emergencyName || "";
                document.getElementById('emergencyPhone').value = empData.emergencyPhone || "";
            }
        });

        function updateEmployee() {
            const params = new URLSearchParams(window.location.search);
            const idToEdit = params.get('id');
            let employees = JSON.parse(localStorage.getItem('addedEmployees')) || [];

            const updatedData = {
                id: document.getElementById('empID').value,
                fullName: document.getElementById('lastName').value + ", " + document.getElementById('firstName').value,
                dept: document.getElementById('dept').value,
                pos: document.getElementById('pos').value,
                status: document.getElementById('empStatus').value,
                empType: document.getElementById('empType').value,
                dateHired: document.getElementById('dateHired').value,
                email: document.getElementById('email').value,
                contact: document.getElementById('contact').value,
                address: document.getElementById('address').value,
                emergencyName: document.getElementById('emergencyName').value,
                emergencyPhone: document.getElementById('emergencyPhone').value
            };

            const index = employees.findIndex(e => e.id === idToEdit);

            if (index !== -1) {
                employees[index] = updatedData;
            } else {
                employees.push(updatedData);
            }

            localStorage.setItem('addedEmployees', JSON.stringify(employees));
            alert("Record updated successfully!");
            
            // Redirect using the new return logic
            window.location.href = getReturnURL();
        }

        document.getElementById('deleteBtn').onclick = function() {
            const params = new URLSearchParams(window.location.search);
            const idToEdit = params.get('id');
            if(confirm("Are you sure you want to delete this record?")) {
                let employees = JSON.parse(localStorage.getItem('addedEmployees')) || [];
                employees = employees.filter(e => e.id !== idToEdit);
                localStorage.setItem('addedEmployees', JSON.stringify(employees));
                
                // After delete, always go back to the list
                window.location.href = 'list.html';
            }
        };
    </script>
</body>
</html>